<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="View and plan mental wellness events and activities on our community calendar.">
  <title>Calendar â€” New Horizon</title>
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/calendar.css">
</head>
<body class="calendar-body">
  <header data-partial="header"></header>

  <main>
    <section class="section calendar-hero">
      <div class="container">
        <h1 class="calendar-hero__title">Wellness Calendar</h1>
        <p class="calendar-hero__description">Explore upcoming events, workshops, and activities to support your mental wellness journey.</p>
      </div>
    </section>

    <section class="section section--alt">
      <div class="container">
        <div class="calendar">
          <div class="calendar-header">
            <button id="prev-btn" class="calendar-nav-btn">&lt;</button>
            <h2 id="month-year" class="calendar-month"></h2>
            <button id="next-btn" class="calendar-nav-btn">&gt;</button>
          </div>
          <table id="calendar-table" class="calendar-table">
            <thead>
              <tr>
                <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
              </tr>
            </thead>
            <tbody id="calendar-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="container">
        <h2>Upcoming Events</h2>
        <div id="events-list">
          <p>Loading events...</p>
        </div>
      </div>
    </section>
  </main>

  <footer data-partial="footer"></footer>
  <script src="../js/config.js"></script>
  <script src="../js/app.js"></script>
  <script src="../js/api.js"></script>
  <script>
    let currentDate = new Date();
    let events = [];

    document.addEventListener('DOMContentLoaded', async () => {
      await loadEvents();
      renderCalendar();
      setupNavigation();
    });

    async function loadEvents() {
      try {
        const data = await API.calendar.getEvents();
        events = data.events || [];
        renderEventsList();
      } catch (error) {
        console.error('Error loading events:', error);
        document.getElementById('events-list').innerHTML = '<p>Failed to load events.</p>';
      }
    }

    function setupNavigation() {
      document.getElementById('prev-btn').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      });
      document.getElementById('next-btn').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      });
    }

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('month-year').textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();

      let html = '';
      let day = 1;

      for (let i = 0; i < 6; i++) {
        html += '<tr>';
        for (let j = 0; j < 7; j++) {
          if (i === 0 && j < firstDay) {
            html += '<td class="calendar-empty"></td>';
          } else if (day > daysInMonth) {
            html += '<td class="calendar-empty"></td>';
          } else {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const hasEvent = events.some(e => e.date === dateStr);
            const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;

            let classes = 'calendar-day';
            if (isToday) classes += ' calendar-today';
            if (hasEvent) classes += ' calendar-has-event';

            html += `<td class="${classes}" data-date="${dateStr}">${day}</td>`;
            day++;
          }
        }
        html += '</tr>';
        if (day > daysInMonth) break;
      }

      document.getElementById('calendar-body').innerHTML = html;

      document.querySelectorAll('.calendar-has-event').forEach(cell => {
        cell.addEventListener('click', () => showEventsForDate(cell.dataset.date));
      });
    }

    function renderEventsList() {
      const container = document.getElementById('events-list');
      const today = new Date().toISOString().split('T')[0];
      const upcomingEvents = events.filter(e => e.date >= today).sort((a, b) => a.date.localeCompare(b.date));

      if (upcomingEvents.length === 0) {
        container.innerHTML = '<p class="no-events">No upcoming events scheduled.</p>';
        return;
      }

      container.innerHTML = `
        <div class="events-grid">
          ${upcomingEvents.map(e => `
            <div class="event-card">
              <div class="event-date">${formatDate(e.date)}</div>
              <div class="event-details">
                ${e.url ? `<a href="${e.url}" target="_blank" class="event-link">View Event Details</a>` : '<span>No link available</span>'}
                ${e.user_name ? `<span class="event-author">By ${e.user_name}</span>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function showEventsForDate(date) {
      const dayEvents = events.filter(e => e.date === date);
      if (dayEvents.length === 0) return;

      alert(`Events on ${formatDate(date)}:\n\n${dayEvents.map(e => e.url || 'Event').join('\n')}`);
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
    }
  </script>
</body>
</html>
